# ============================================
# PROJETO: WineBrain
# Sistema de Apoio à Decisão para Vinícolas
# ============================================

# API Backend WineBrain
location /winebrain/api/ {
    # Remove o prefixo /winebrain do path antes de passar para o backend
    rewrite ^/winebrain/api/(.*) /api/$1 break;
    
    proxy_pass http://winebrain_backend;
    include /etc/nginx/includes/proxy-params.conf;

    # CORS Headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # Preflight requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Max-Age' 86400 always;
        add_header 'Content-Type' 'text/plain; charset=utf-8' always;
        add_header 'Content-Length' 0 always;
        return 204;
    }

    # Timeouts para API
    proxy_read_timeout 60s;
    proxy_connect_timeout 10s;
    
    # Sem cache para API
    add_header Cache-Control "no-store, no-cache, must-revalidate";
    expires off;
}

# Frontend WineBrain - Assets estáticos
location ~ ^/winebrain/(assets/|.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot))$ {
    proxy_pass http://winebrain_app;
    include /etc/nginx/includes/proxy-params.conf;

    add_header 'Access-Control-Allow-Origin' '*' always;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Frontend WineBrain - SPA
location /winebrain/ {
    proxy_pass http://winebrain_app/;
    include /etc/nginx/includes/proxy-params.conf;

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    expires off;
}

# Redirecionamento /winebrain -> /winebrain/
location = /winebrain {
    return 301 /winebrain/;
}
