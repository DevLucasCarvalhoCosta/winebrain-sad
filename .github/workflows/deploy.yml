name: ğŸš€ Deploy WineBrain to UEG Server

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:

env:
  PROJECT_NAME: winebrain-sad
  COMPOSE_DIR: docker-ueg-projects

jobs:
  # Job 1: Build e Test
  build-and-test:
    name: ğŸ”¨ Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Test Backend Health
        working-directory: ./backend
        run: |
          python -c "from api.main import app; print('âœ… Backend imports OK')"

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: https://patrimonioueg.duckdns.org/winebrain/api
        run: npm run build

      - name: âœ… Verify Build Output
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "âŒ Build failed - dist directory not found"
            exit 1
          fi
          echo "âœ… Frontend build successful"

  # Job 2: Deploy to Server
  deploy:
    name: ğŸš¢ Deploy to UEG Server
    runs-on: ubuntu-latest
    needs: build-and-test
    environment:
      name: production
      url: https://patrimonioueg.duckdns.org/winebrain/
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Deploy to Server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            
            echo "============================================"
            echo "ğŸ· WineBrain - Deploy AutomÃ¡tico via GitHub Actions"
            echo "============================================"
            
            # Cores para output
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            RED='\033[0;31m'
            NC='\033[0m'
            
            # VariÃ¡veis
            PROJECT_DIR="$HOME/${{ env.PROJECT_NAME }}"
            COMPOSE_DIR="$HOME/${{ env.COMPOSE_DIR }}"
            
            # FunÃ§Ã£o para log
            log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
            log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
            log_error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
            
            # 1. Verificar se projeto existe, senÃ£o clonar
            if [ ! -d "$PROJECT_DIR" ]; then
              log_info "Primeira vez - clonando repositÃ³rio..."
              cd ~
              git clone https://github.com/${{ github.repository }}.git
              cd $PROJECT_DIR
            else
              log_info "Atualizando cÃ³digo do GitHub..."
              cd $PROJECT_DIR
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            fi
            
            # 2. Verificar dados
            log_info "Verificando dados..."
            if [ ! -f "$PROJECT_DIR/data/processed/clientes_agregado.csv" ]; then
              log_warn "âš ï¸ Dados processados nÃ£o encontrados em data/processed/"
              log_warn "Os containers vÃ£o iniciar, mas a aplicaÃ§Ã£o pode nÃ£o funcionar corretamente."
            fi
            
            if [ ! -f "$PROJECT_DIR/data/models/churn_model.pkl" ]; then
              log_warn "âš ï¸ Modelo ML nÃ£o encontrado em data/models/"
            fi
            
            # 3. Copiar configuraÃ§Ãµes Nginx (se necessÃ¡rio)
            log_info "Verificando configuraÃ§Ãµes Nginx..."
            
            if [ ! -f "$COMPOSE_DIR/docker/nginx/includes/app-winebrain.conf" ]; then
              log_info "Copiando configuraÃ§Ã£o Nginx..."
              mkdir -p "$COMPOSE_DIR/docker/nginx/includes"
              cp "$PROJECT_DIR/docker/nginx/includes/app-winebrain.conf" \
                 "$COMPOSE_DIR/docker/nginx/includes/"
            fi
            
            if [ ! -f "$COMPOSE_DIR/docker/nginx/conf.d/winebrain-upstreams.conf" ]; then
              log_info "Copiando upstreams Nginx..."
              mkdir -p "$COMPOSE_DIR/docker/nginx/conf.d"
              cp "$PROJECT_DIR/docker/nginx/conf.d/winebrain-upstreams.conf" \
                 "$COMPOSE_DIR/docker/nginx/conf.d/"
            fi
            
            # 4. Build das imagens
            log_info "ğŸ”¨ Fazendo build das imagens Docker..."
            cd "$COMPOSE_DIR"
            
            docker-compose build \
              --build-arg VITE_API_BASE_URL=https://patrimonioueg.duckdns.org/winebrain/api \
              winebrain-backend winebrain-frontend || log_error "Build falhou!"
            
            # 5. Parar containers antigos
            log_info "Parando containers antigos..."
            docker-compose stop winebrain-backend winebrain-frontend 2>/dev/null || true
            
            # 6. Iniciar novos containers
            log_info "ğŸš€ Iniciando containers..."
            docker-compose up -d winebrain-backend winebrain-frontend || log_error "Falha ao iniciar containers!"
            
            # 7. Reiniciar nginx
            log_info "Reiniciando Nginx Gateway..."
            docker-compose restart nginx
            
            # 8. Aguardar serviÃ§os ficarem prontos
            log_info "â³ Aguardando serviÃ§os iniciarem (15s)..."
            sleep 15
            
            # 9. Verificar status
            log_info "Verificando status dos containers..."
            if docker ps | grep -q winebrain-backend && docker ps | grep -q winebrain-frontend; then
              log_info "âœ… Containers rodando"
            else
              log_error "âŒ Containers nÃ£o estÃ£o rodando!"
            fi
            
            # 10. Testar health checks
            log_info "ğŸ¥ Testando health checks..."
            
            # Backend direto
            if curl -sf http://localhost:8000/api/health > /dev/null; then
              log_info "âœ… Backend health check: OK"
            else
              log_warn "âš ï¸ Backend health check: FALHOU"
            fi
            
            # API via Nginx
            if curl -sf http://localhost/winebrain/api/health > /dev/null; then
              log_info "âœ… API via Nginx: OK"
            else
              log_warn "âš ï¸ API via Nginx: FALHOU"
            fi
            
            # 11. Mostrar logs recentes
            echo ""
            log_info "ğŸ“‹ Ãšltimas linhas dos logs:"
            echo ""
            echo "=== Backend (Ãºltimas 5 linhas) ==="
            docker logs --tail=5 winebrain-backend 2>&1 | tail -5
            echo ""
            echo "=== Frontend (Ãºltimas 5 linhas) ==="
            docker logs --tail=5 winebrain-frontend 2>&1 | tail -5
            
            # 12. ConclusÃ£o
            echo ""
            echo "============================================"
            log_info "âœ… Deploy concluÃ­do com sucesso!"
            echo "============================================"
            echo ""
            echo "ğŸŒ URL: https://patrimonioueg.duckdns.org/winebrain/"
            echo "ğŸ“š Docs: https://patrimonioueg.duckdns.org/winebrain/api/docs"
            echo ""
            echo "ğŸ“Š Para ver logs em tempo real:"
            echo "  docker logs -f winebrain-backend"
            echo "  docker logs -f winebrain-frontend"
            echo ""
          ENDSSH

      - name: ğŸ§ª Test Deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          echo "ğŸ§ª Testando endpoints..."
          
          # Testar via SSH
          ssh -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            # Testar health check
            if curl -sf http://localhost/winebrain/api/health | grep -q "healthy"; then
              echo "âœ… Health check passou"
              exit 0
            else
              echo "âŒ Health check falhou"
              echo "Logs do backend:"
              docker logs --tail=20 winebrain-backend
              exit 1
            fi
          ENDSSH

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "### ğŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **Application URL:** https://patrimonioueg.duckdns.org/winebrain/" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“š **API Docs:** https://patrimonioueg.duckdns.org/winebrain/api/docs" >> $GITHUB_STEP_SUMMARY

  # Job 3: NotificaÃ§Ã£o (opcional)
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ“¢ Deploy Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deploy realizado com sucesso!"
            echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: https://patrimonioueg.duckdns.org/winebrain/"
          else
            echo "âŒ Deploy falhou! Verifique os logs."
            exit 1
          fi
